<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; style-src 'self'; script-src 'self'; img-src 'self' data:;">
    <title>ğŸ”’ Tab Locked - Locksy</title>
    <link rel="stylesheet" href="../css/locked.css">
    <link rel="icon" id="lockFavicon" type="image/png">
</head>

<body>
    <!-- Stealth Mode: Fake browser error page (shown instead of real lock page when stealth is on) -->
    <div id="stealthOverlay" class="stealth-overlay" style="display:none;" aria-hidden="true">
        <div class="stealth-error-icon-wrap">
            <svg class="stealth-error-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" stroke="#dadce0" stroke-width="2"/>
                <path d="M8 9C8 9 8.5 7 12 7C15.5 7 16 9.5 14 11C12.5 12 12 13 12 14" stroke="#dadce0" stroke-width="2" stroke-linecap="round"/>
                <circle cx="12" cy="17" r="1" fill="#dadce0"/>
            </svg>
        </div>
        <h1 class="stealth-error-title">This site can't be reached</h1>
        <p class="stealth-error-reason">The connection was refused.</p>
        <div class="stealth-error-suggestions">
            <p>Try:</p>
            <ul>
                <li>Checking the connection</li>
                <li>Checking the proxy and the firewall</li>
                <li>Running Windows Network Diagnostics</li>
            </ul>
        </div>
        <p class="stealth-error-code" id="stealthErrorCode" title="Triple-click to reveal lock">ERR_CONNECTION_REFUSED</p>
        <div class="stealth-error-buttons">
            <button class="stealth-btn" onclick="window.history.back()">â† Back</button>
            <button class="stealth-btn stealth-btn-primary" id="stealthReloadBtn">Reload</button>
        </div>
    </div>

    <div class="lock-container">
        <div class="lock-content">
            <div class="lock-icon">ğŸ”’</div>
            <h1>Tab Secured</h1>
            <p class="subtitle" id="lockSubtitle">This tab is protected with military-grade encryption. Verify your
                identity to continue.</p>

            <div class="unlock-section">
                <!-- Biometric-First Unlock (shown when biometric is registered) -->
                <div id="biometricPrimarySection" class="biometric-primary-section hidden">
                    <div class="biometric-scanning-area" id="biometricScanArea">
                        <div class="fingerprint-pulse-icon" id="biometricIcon">ğŸ‘†</div>
                        <p class="biometric-prompt" id="biometricPromptText">Touch your fingerprint sensor to unlock</p>
                        <p class="biometric-subtext" id="biometricSubtext">Verifying your identity...</p>
                    </div>
                    <button id="retryBiometricBtn" class="btn btn-biometric-retry hidden">
                        <span class="btn-icon">ğŸ”„</span>
                        <span>Try Again</span>
                    </button>
                    <div class="biometric-divider">
                        <span>or</span>
                    </div>
                    <button id="usePasswordBtn" class="btn-use-password">
                        <span>ğŸ”‘ Use Password Instead</span>
                    </button>
                </div>

                <!-- Password Section (secondary when biometric available, primary otherwise) -->
                <div id="passwordSection" class="password-section">
                    <div class="input-group">
                        <input type="password" id="passwordInput" placeholder="Enter your password" autocomplete="off"
                            spellcheck="false">
                    </div>

                    <button id="unlockBtn" class="btn btn-unlock">
                        <span class="btn-icon">ğŸ”“</span>
                        <span>Unlock Tab</span>
                    </button>

                    <!-- Back to biometric option (shown when biometric is available) -->
                    <div id="backToBiometric" class="back-to-biometric hidden">
                        <div class="biometric-divider"><span>or</span></div>
                        <button id="switchToBiometricBtn" class="btn-switch-biometric">
                            <span class="btn-icon" id="switchBiometricIcon">ğŸ‘†</span>
                            <span id="switchBiometricText">Unlock with Fingerprint</span>
                        </button>
                    </div>
                </div>

                <div id="errorMessage" class="error-message"></div>
                <div id="successMessage" class="success-message"></div>

                <div id="loadingSpinner" class="loading">
                    <div class="spinner"></div>
                </div>

                <div id="rateLimitInfo" class="rate-limit-info"></div>
            </div>

            <div class="security-info">
                <div class="security-badge">
                    <span class="badge-icon">ğŸ›¡ï¸</span>
                    <span>Secured with Advanced Encryption</span>
                </div>
            </div>
        </div>

        <!-- Unlock Scope Selection (shown for domain-locked tabs) -->
        <div class="scope-selection hidden" id="scopeSelection">
            <div class="success-icon">âœ…</div>
            <h1>Password Correct!</h1>
            <p class="subtitle">This tab is protected by a domain lock.<br>Choose unlock scope:</p>

            <button id="unlockThisTabBtn" class="btn btn-scope btn-primary">
                <span class="btn-icon">ğŸ”“</span>
                <span>Unlock This Tab Only</span>
            </button>

            <button id="unlockAllTabsBtn" class="btn btn-scope btn-secondary">
                <span class="btn-icon">ğŸŒ</span>
                <span id="unlockAllText">Unlock All Domain Tabs</span>
            </button>

            <div class="remember-choice">
                <label>
                    <input type="checkbox" id="rememberChoice">
                    <span>Remember this choice for <strong id="domainName"></strong></span>
                </label>
                <small>You can change this in Domain Lock Manager settings</small>
            </div>

            <p class="note"><strong>Note:</strong> "This Tab Only" keeps the domain lock active but temporarily unlocks
                this tab.</p>
        </div>
    </div>

    <script src="../js/crypto-utils.js"></script>
    <script src="../js/webauthn-utils.js"></script>
    <script src="../js/locked.js"></script>
</body>

</html>