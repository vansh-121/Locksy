name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build extension
        run: npm run build
        
      - name: Generate checksums
        run: |
          cd dist
          sha256sum locksy-chrome.zip > checksums.txt
          sha256sum locksy-firefox.zip >> checksums.txt
          cat checksums.txt
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/locksy-chrome.zip
            dist/locksy-firefox.zip
            dist/checksums.txt
          body: |
            ## üîí Locksy v${{ github.ref_name }}
            
            ### Verify Your Download
            
            **SHA-256 Checksums:**
            ```
            $(cat dist/checksums.txt)
            ```
            
            ### Installation
            - **Chrome/Edge**: Download `locksy-chrome.zip`, extract, and load unpacked in developer mode
            - **Firefox**: Download `locksy-firefox.zip` for manual installation
            
            ### Verification Steps
            1. Download the `.zip` file for your browser
            2. Extract and compare files with this repository
            3. Verify the checksum matches above
            4. Build from source: `npm run build` and compare
            
            ### Source Code
            This release is built from commit: ${{ github.sha }}
            
            **üîç Trust & Transparency:**
            - All builds are automated via GitHub Actions (see `.github/workflows/release.yml`)
            - Source code is 100% available in this repository
            - No obfuscation, no hidden code
            - You can build it yourself and verify it matches
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extension-builds
          path: dist/
          retention-days: 90
